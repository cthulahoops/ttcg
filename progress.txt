# PRD Progress Summary

## Completed: unused-client

Fixed unused imports and code in client files:

- client/App.tsx: Removed unused `useState` import
- client/GameLog.tsx: Wired up `CopyLogButton` (was defined but not rendered)
- client/LobbyMenu.tsx: Removed unused `handleGenerateCode` function
- client/usePlayerId.ts: Removed unused `useRef` import

All 4 issues from the prd.json "unused-client" item have been resolved.
Type check confirms the fixes are valid.

## Completed: unused-server

Fixed unused imports in server files:

- server/game-server.ts: Removed unused `runGame` import
- server/game-server.ts: Removed unused `characterRegistry` import
- server/smoke.ts: Removed unused `Game` import

All 2 files from the prd.json "unused-server" item have been cleaned up.
Type check confirms no new errors introduced.

## Completed: unused-shared

Fixed unused imports and parameters in shared files:

- shared/game.ts: Removed unused `PlayerHand`, `PyramidHand`, `SolitaireHand` imports
- shared/game.ts: Removed unused `AIController` import
- shared/game.ts: Removed unused `Controller` type import
- shared/game.ts: Removed unused `allCharacterNames` import and `allCharacters` constant
- shared/hands.ts: Prefixed unused `isOwnSeat` parameter with underscore in PyramidHand.serializeForViewer
- shared/hands.ts: Prefixed unused `isOwnSeat` parameter with underscore in SolitaireHand.serializeForViewer

All issues from the prd.json "unused-shared" item have been resolved.
Type check confirms no TS6xxx (unused) errors remain in these files.

## Completed: undefined-client

Fixed possibly undefined 'seat' access in client files:

- client/GameStatus.tsx: Added early return when seat is undefined
- client/TrickArea.tsx: Used optional chaining (seat?.character, seat?.playerName) for safe access

Both client type errors (TS18048) have been resolved.
Type check confirms no client errors remain.

## Completed: undefined-game-server

Fixed possibly undefined access in server/game-server.ts:

- Lines 21-24: Extracted `controllers[0]` into `singleController` const with non-null assertion before pushing
- Line 52: Added non-null assertion to `playerCards[p]!` since `p` is bounded by `numCharacters`
- Line 63: Added non-null assertion to `controllers[i]!` since `i` is bounded by `numCharacters`

All 3 type errors (TS2345, TS2532, TS2322) in game-server.ts have been resolved.
Type check confirms no game-server.ts errors remain.

## Completed: undefined-utilities

Fixed possibly undefined access in shared utility files:

- shared/hands.ts:299 - Added non-null assertions to array swap in `_ensureOneRingRevealed` (indices are guaranteed valid by preceding check)
- shared/utils.ts:31 - Added non-null assertions to array swap in `shuffleDeck` (Fisher-Yates shuffle indices are always valid)
- shared/controllers.ts:88 - Added non-null assertion in `randomChoice` return (function is called with non-empty arrays)

All 3 type errors (TS2322) in shared utilities have been resolved.
Type check confirms no errors remain in hands.ts, utils.ts, or controllers.ts.

## Completed: undefined-characters

Fixed possibly undefined access in shared/characters/registry.ts:

- Goldberry.objective.check (line 415): Added non-null assertions for `trickNumbers[0]!` and `trickNumbers[1]!` after length check
- Goldberry.objective.isCompletable (line 437): Added non-null assertions for `trickNumbers[i]!` and `trickNumbers[i-1]!` in loop
- Goldberry.objective.isCompletable (line 444): Added undefined check for `maxTrickWon` before using it
- GildorInglorian.objective.check (line 573): Fixed boolean | undefined return by adding explicit undefined check for `lastCardPlayed`
- Elrond.setup (lines 876-891): Changed indexed loop to for-of for first loop, added non-null assertions for array access in second and third loops

All 11 type errors (TS2532, TS18048, TS2322, TS2345) in registry.ts have been resolved.
Type check confirms no registry.ts errors remain.

## Completed: undefined-game

Fixed ~30 TypeScript errors in shared/game.ts related to possibly undefined array access:

**Design improvement**: Refactored `isLegalMove` and `getLegalMoves` to take `Seat` instead of `playerIndex`. This pushes undefined checking to call sites with proper context, rather than silently returning empty results which could mask bugs.

**Key fixes**:
- setupExchange: Added guards for validPlayers[0] and seats[targetIndex] lookups
- getGameOverMessage: Added safe seat lookup in winner name mapping
- determineTrickWinner: Added guard for currentTrick[0] with explicit error for empty tricks
- playSelectedCard/selectCardFromPlayer: Refactored to take Seat parameter directly
- runTrickTakingPhase: Get seat once at loop start with throw on invalid index; fixed oneRingPlay and winner seat access
- runSetupPhase: Added seat validation with throw on invalid index
- runCharacterAssignment: Added validation for frodoSeat, pyramid seat, and loop seats

All 33 TypeScript errors have been resolved.
Type check confirms no errors remain in shared/game.ts.

## Completed: sort-characters-alphabetically

Sorted available characters alphabetically for easier selection:

- server/game-server.ts: Added `.sort()` call after creating available characters list

Characters are now displayed in alphabetical order (e.g., Aragorn, Arwen, Boromir, Frodo...)
instead of random shuffle order. This makes it easier for players to find their preferred character.
Type check confirms no errors introduced.

## Completed: give-card-recipient

Show recipient name in Give Card dialog:

The `DecisionDialog` React component was not displaying the `message` field from choice options,
which meant the recipient's name wasn't shown in card-giving dialogs (e.g., Fatty Bolger's setup).

**Fix (client/DecisionDialog.tsx)**:
- Added `message` prop to the internal `Dialog` component
- Rendered message as `<p className="dialog-message">` between title and buttons
- Updated both `choose_button` and `choose_card` cases to pass `decision.options.message`

Now the dialog shows "Choose a card to give to [Character Name]" below the title.
The CSS class `.dialog-message` already existed with appropriate styling.

Type check passes with no errors.

## Completed: fatty-card-reveal

Publish gameState on card reveal for Fatty Bolger:

In 1-player mode, Fatty Bolger's setup reveals their hand before the card gift dialogs.
However, the `revealHand()` method wasn't calling `notifyStateChange()`, so the game
state wasn't published until the next operation (`giveCard()`). This caused the card
gift dialog to appear before the revealed cards were visible to the player.

**Fix (shared/game.ts)**:
- Added `this.notifyStateChange()` call at the end of `revealHand()` method

Now the revealed cards are visible before the gift dialog appears, as expected.
Type check passes with no errors.

## Completed: one-ring-skip-prompt

Skip one ring trump prompt when already winning:

When the 1 of Rings is played, the player is asked whether to use it as trump to win
the trick. However, if the 1 of Rings would already win without trump (i.e., rings is
the lead suit and no higher rings card was played), this prompt is unnecessary and
disrupts gameplay.

**Fix (shared/game.ts)**:
- Added `alreadyWinning` check before showing the trump prompt
- Condition: `leadSuit === "rings"` AND no rings card with `value > 1` was played
- When already winning, skip the prompt entirely (normal trick winner logic applies)

This improves UX by avoiding an obvious "Yes" choice when the player would win anyway.
Type check passes with no errors.

## Completed: log-player-names

Show player names instead of numbers in game log:

Before this change, log messages during character selection showed "Player 1 chose Gandalf"
instead of the actual player names. The `getDisplayName()` method fell back to "Player X"
when no character was assigned, ignoring `controller.playerName`.

**Fix (shared/seat.ts)**:
- Updated `getDisplayName()` to use `controller.playerName ?? 'Player ${seatIndex + 1}'`
  as fallback when no character is assigned yet
- Removed "(You)" annotations throughout since player names make them redundant
- Kept "(Pyramid)" annotation as it indicates a game mode, not a player identity

Now for networked games:
- Before character selection: Shows actual player names (e.g., "Alice chose Gandalf")
- After character selection: Shows character names (e.g., "Gandalf plays 3 of Hills")

For local/solitaire games, falls back to "Player X" when no name is set.
Type check passes with no errors.

## Completed: broken-rings-indicator

Add visual indication when rings are broken:

In this trick-taking game, players cannot lead with Rings suit cards until rings have
been "broken" (a Rings card has been played for any reason). The `ringsBroken` flag
was tracked in the game state and serialized to clients, but there was no visual
indicator showing this state to players.

**Changes**:
- `client/TrickArea.tsx`: Added a rings status indicator next to the trick area title
  - Wrapped h2 and indicator in a `.trick-header` div
  - Shows "Rings: Sealed" (blue styling) when rings haven't been broken yet
  - Shows "Rings: Broken" (orange styling) once any Rings card has been played
- `client/game.css`: Added styling for the rings status badge
  - Added `.trick-header` flex container for title and indicator
  - Added `.trick-header h2` to remove margin for proper alignment
  - Added `.rings-status` base styles with padding and border-radius
  - Added `.rings-status.sealed` with blue color scheme
  - Added `.rings-status.broken` with orange color scheme

This helps players understand when they can lead with Rings cards.
Type check passes with no errors.

## Completed: exchange-privacy

Respect privacy in exchange log messages:

When players exchange cards during setup (e.g., Frodo exchanging with Gandalf), the log
previously showed card details to ALL players. This leaked private information about
cards transferred between specific players.

**Changes**:
- `shared/game.ts`: Extended `log()` method signature to accept visibility options:
  - `visibleTo?: number[]` - seat indices that should see the detailed message
  - `hiddenMessage?: string` - alternative message shown to non-participants
- `shared/game.ts`: Updated `giveCard()` to use privacy-aware logging:
  - Participants see: "Gandalf gives 3 of Hills to Frodo"
  - Others see: "Gandalf gives a card to Frodo"
- `shared/game.ts`: Updated `completeExchange()` to use privacy-aware logging:
  - Both log lines (one per direction) now respect participant privacy
- `server/room-manager.ts`: Updated `onLog` callback to handle per-seat messaging:
  - Looks up each player's seat via their controller
  - Sends detailed message to participants, hidden message to others

Now only players involved in an exchange see the specific cards traded.
Type check passes with no errors.
