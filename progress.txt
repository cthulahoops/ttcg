# PRD Progress Summary

## Completed: unused-client

Fixed unused imports and code in client files:

- client/App.tsx: Removed unused `useState` import
- client/GameLog.tsx: Wired up `CopyLogButton` (was defined but not rendered)
- client/LobbyMenu.tsx: Removed unused `handleGenerateCode` function
- client/usePlayerId.ts: Removed unused `useRef` import

All 4 issues from the prd.json "unused-client" item have been resolved.
Type check confirms the fixes are valid.

## Completed: unused-server

Fixed unused imports in server files:

- server/game-server.ts: Removed unused `runGame` import
- server/game-server.ts: Removed unused `characterRegistry` import
- server/smoke.ts: Removed unused `Game` import

All 2 files from the prd.json "unused-server" item have been cleaned up.
Type check confirms no new errors introduced.

## Completed: unused-shared

Fixed unused imports and parameters in shared files:

- shared/game.ts: Removed unused `PlayerHand`, `PyramidHand`, `SolitaireHand` imports
- shared/game.ts: Removed unused `AIController` import
- shared/game.ts: Removed unused `Controller` type import
- shared/game.ts: Removed unused `allCharacterNames` import and `allCharacters` constant
- shared/hands.ts: Prefixed unused `isOwnSeat` parameter with underscore in PyramidHand.serializeForViewer
- shared/hands.ts: Prefixed unused `isOwnSeat` parameter with underscore in SolitaireHand.serializeForViewer

All issues from the prd.json "unused-shared" item have been resolved.
Type check confirms no TS6xxx (unused) errors remain in these files.

## Completed: undefined-client

Fixed possibly undefined 'seat' access in client files:

- client/GameStatus.tsx: Added early return when seat is undefined
- client/TrickArea.tsx: Used optional chaining (seat?.character, seat?.playerName) for safe access

Both client type errors (TS18048) have been resolved.
Type check confirms no client errors remain.

## Completed: undefined-game-server

Fixed possibly undefined access in server/game-server.ts:

- Lines 21-24: Extracted `controllers[0]` into `singleController` const with non-null assertion before pushing
- Line 52: Added non-null assertion to `playerCards[p]!` since `p` is bounded by `numCharacters`
- Line 63: Added non-null assertion to `controllers[i]!` since `i` is bounded by `numCharacters`

All 3 type errors (TS2345, TS2532, TS2322) in game-server.ts have been resolved.
Type check confirms no game-server.ts errors remain.

## Completed: undefined-utilities

Fixed possibly undefined access in shared utility files:

- shared/hands.ts:299 - Added non-null assertions to array swap in `_ensureOneRingRevealed` (indices are guaranteed valid by preceding check)
- shared/utils.ts:31 - Added non-null assertions to array swap in `shuffleDeck` (Fisher-Yates shuffle indices are always valid)
- shared/controllers.ts:88 - Added non-null assertion in `randomChoice` return (function is called with non-empty arrays)

All 3 type errors (TS2322) in shared utilities have been resolved.
Type check confirms no errors remain in hands.ts, utils.ts, or controllers.ts.

## Completed: undefined-characters

Fixed possibly undefined access in shared/characters/registry.ts:

- Goldberry.objective.check (line 415): Added non-null assertions for `trickNumbers[0]!` and `trickNumbers[1]!` after length check
- Goldberry.objective.isCompletable (line 437): Added non-null assertions for `trickNumbers[i]!` and `trickNumbers[i-1]!` in loop
- Goldberry.objective.isCompletable (line 444): Added undefined check for `maxTrickWon` before using it
- GildorInglorian.objective.check (line 573): Fixed boolean | undefined return by adding explicit undefined check for `lastCardPlayed`
- Elrond.setup (lines 876-891): Changed indexed loop to for-of for first loop, added non-null assertions for array access in second and third loops

All 11 type errors (TS2532, TS18048, TS2322, TS2345) in registry.ts have been resolved.
Type check confirms no registry.ts errors remain.

## Completed: undefined-game

Fixed ~30 TypeScript errors in shared/game.ts related to possibly undefined array access:

**Design improvement**: Refactored `isLegalMove` and `getLegalMoves` to take `Seat` instead of `playerIndex`. This pushes undefined checking to call sites with proper context, rather than silently returning empty results which could mask bugs.

**Key fixes**:
- setupExchange: Added guards for validPlayers[0] and seats[targetIndex] lookups
- getGameOverMessage: Added safe seat lookup in winner name mapping
- determineTrickWinner: Added guard for currentTrick[0] with explicit error for empty tricks
- playSelectedCard/selectCardFromPlayer: Refactored to take Seat parameter directly
- runTrickTakingPhase: Get seat once at loop start with throw on invalid index; fixed oneRingPlay and winner seat access
- runSetupPhase: Added seat validation with throw on invalid index
- runCharacterAssignment: Added validation for frodoSeat, pyramid seat, and loop seats

All 33 TypeScript errors have been resolved.
Type check confirms no errors remain in shared/game.ts.

## Completed: sort-characters-alphabetically

Sorted available characters alphabetically for easier selection:

- server/game-server.ts: Added `.sort()` call after creating available characters list

Characters are now displayed in alphabetical order (e.g., Aragorn, Arwen, Boromir, Frodo...)
instead of random shuffle order. This makes it easier for players to find their preferred character.
Type check confirms no errors introduced.

## Completed: give-card-recipient

Show recipient name in Give Card dialog:

The `DecisionDialog` React component was not displaying the `message` field from choice options,
which meant the recipient's name wasn't shown in card-giving dialogs (e.g., Fatty Bolger's setup).

**Fix (client/DecisionDialog.tsx)**:
- Added `message` prop to the internal `Dialog` component
- Rendered message as `<p className="dialog-message">` between title and buttons
- Updated both `choose_button` and `choose_card` cases to pass `decision.options.message`

Now the dialog shows "Choose a card to give to [Character Name]" below the title.
The CSS class `.dialog-message` already existed with appropriate styling.

Type check passes with no errors.

## Completed: fatty-card-reveal

Publish gameState on card reveal for Fatty Bolger:

In 1-player mode, Fatty Bolger's setup reveals their hand before the card gift dialogs.
However, the `revealHand()` method wasn't calling `notifyStateChange()`, so the game
state wasn't published until the next operation (`giveCard()`). This caused the card
gift dialog to appear before the revealed cards were visible to the player.

**Fix (shared/game.ts)**:
- Added `this.notifyStateChange()` call at the end of `revealHand()` method

Now the revealed cards are visible before the gift dialog appears, as expected.
Type check passes with no errors.

## Completed: one-ring-skip-prompt

Skip one ring trump prompt when already winning:

When the 1 of Rings is played, the player is asked whether to use it as trump to win
the trick. However, if the 1 of Rings would already win without trump (i.e., rings is
the lead suit and no higher rings card was played), this prompt is unnecessary and
disrupts gameplay.

**Fix (shared/game.ts)**:
- Added `alreadyWinning` check before showing the trump prompt
- Condition: `leadSuit === "rings"` AND no rings card with `value > 1` was played
- When already winning, skip the prompt entirely (normal trick winner logic applies)

This improves UX by avoiding an obvious "Yes" choice when the player would win anyway.
Type check passes with no errors.

## Completed: log-player-names

Show player names instead of numbers in game log:

Before this change, log messages during character selection showed "Player 1 chose Gandalf"
instead of the actual player names. The `getDisplayName()` method fell back to "Player X"
when no character was assigned, ignoring `controller.playerName`.

**Fix (shared/seat.ts)**:
- Updated `getDisplayName()` to use `controller.playerName ?? 'Player ${seatIndex + 1}'`
  as fallback when no character is assigned yet
- Removed "(You)" annotations throughout since player names make them redundant
- Kept "(Pyramid)" annotation as it indicates a game mode, not a player identity

Now for networked games:
- Before character selection: Shows actual player names (e.g., "Alice chose Gandalf")
- After character selection: Shows character names (e.g., "Gandalf plays 3 of Hills")

For local/solitaire games, falls back to "Player X" when no name is set.
Type check passes with no errors.

## Completed: broken-rings-indicator

Add visual indication when rings are broken:

In this trick-taking game, players cannot lead with Rings suit cards until rings have
been "broken" (a Rings card has been played for any reason). The `ringsBroken` flag
was tracked in the game state and serialized to clients, but there was no visual
indicator showing this state to players.

**Changes**:
- `client/TrickArea.tsx`: Added a rings status indicator next to the trick area title
  - Wrapped h2 and indicator in a `.trick-header` div
  - Shows "Rings: Sealed" (blue styling) when rings haven't been broken yet
  - Shows "Rings: Broken" (orange styling) once any Rings card has been played
- `client/game.css`: Added styling for the rings status badge
  - Added `.trick-header` flex container for title and indicator
  - Added `.trick-header h2` to remove margin for proper alignment
  - Added `.rings-status` base styles with padding and border-radius
  - Added `.rings-status.sealed` with blue color scheme
  - Added `.rings-status.broken` with orange color scheme

This helps players understand when they can lead with Rings cards.
Type check passes with no errors.

## Completed: exchange-privacy

Respect privacy in exchange log messages:

When players exchange cards during setup (e.g., Frodo exchanging with Gandalf), the log
previously showed card details to ALL players. This leaked private information about
cards transferred between specific players.

**Changes**:
- `shared/game.ts`: Extended `log()` method signature to accept visibility options:
  - `visibleTo?: number[]` - seat indices that should see the detailed message
  - `hiddenMessage?: string` - alternative message shown to non-participants
- `shared/game.ts`: Updated `giveCard()` to use privacy-aware logging:
  - Participants see: "Gandalf gives 3 of Hills to Frodo"
  - Others see: "Gandalf gives a card to Frodo"
- `shared/game.ts`: Updated `completeExchange()` to use privacy-aware logging:
  - Both log lines (one per direction) now respect participant privacy
- `server/room-manager.ts`: Updated `onLog` callback to handle per-seat messaging:
  - Looks up each player's seat via their controller
  - Sends detailed message to participants, hidden message to others

Now only players involved in an exchange see the specific cards traded.
Type check passes with no errors.

## Completed: hills-color

Make hills suit color browner:

The Hills suit cards previously used a golden/yellow color gradient that was too similar
to the Rings suit and didn't evoke the earthy "hills" theme well.

**Fix (client/game.css)**:
- Changed `.card.hills` background gradient from `#ccb342 → #aea551` (golden yellow)
  to `#c4965c → #a8824a` (warm tan-brown)

The new colors are noticeably browner with more red and less green, creating an
earthier appearance that better represents rolling hills while maintaining good
contrast for readability.

## Completed: split-character-registry

Split characters/registry.ts into one file per character:

The original registry.ts contained all 25 character definitions in a single 1253-line file.
This made it difficult to find and modify individual character implementations. Splitting
into separate files is a precondition for implementing completedness checks.

**New file structure (shared/characters/)**:
- `types.ts` - Shared interfaces: CharacterDefinition, CharacterObjective, CharacterDisplay
- Individual character files (25 total):
  - `frodo.ts`, `gandalf.ts`, `merry.ts`, `celeborn.ts`, `pippin.ts`
  - `boromir.ts`, `sam.ts`, `gimli.ts`, `legolas.ts`, `aragorn.ts`
  - `goldberry.ts`, `glorfindel.ts`, `galadriel.ts`, `gildor-inglorian.ts`
  - `farmer-maggot.ts`, `fatty-bolger.ts`, `tom-bombadil.ts`
  - `barliman-butterbur.ts`, `bill-the-pony.ts`, `elrond.ts`
  - `arwen.ts`, `gloin.ts`, `bilbo-baggins.ts`, `gwaihir.ts`, `shadowfax.ts`
- `registry.ts` - Imports all characters and exports characterRegistry and allCharacterNames

**Unchanged external API**:
- `characterRegistry` - Map<string, CharacterDefinition> (same as before)
- `allCharacterNames` - string[] (same as before)
- Type exports via `export type { CharacterDefinition, ... }` from registry.ts

Each character file exports a single const with the character definition, containing
its name, setupText, setup function, objective, and display configuration.
Type check passes with no errors.

## Completed: completedness-checks

Implement isCompleted for each character:

Added `isCompleted` method to the `CharacterObjective` interface and implemented it for all
25 characters. This method returns true when a character's objective is definitively completed
and cannot be undone, enabling the early-victory-exit feature (future PRD item).

**Interface change (shared/characters/types.ts)**:
- Added `isCompleted: (game: Game, seat: Seat) => boolean` to CharacterObjective

**Implementation categories**:

1. **"At least X" objectives (isCompleted = check)**:
   Once met, these cannot be undone since won cards/tricks are permanent.
   - Gandalf: Win at least one trick
   - Frodo: Win at least 2/4 ring cards
   - Sam/Legolas/Gimli: Win specific threat card
   - Celeborn: Win 3+ cards of same rank
   - Glorfindel: Win all 8 shadows cards
   - Gwaihir: Win 2+ tricks with mountains
   - Shadowfax: Win 2+ tricks with hills
   - Farmer Maggot: Win 2+ cards matching threat rank
   - Barliman Butterbur: Win 1+ of last 3 tricks
   - Elrond: Every character has won a ring

2. **"Exact count" objectives (isCompleted = finished && check)**:
   Could be undone by winning too many; must wait for game end.
   - Merry: Exactly 1 or 2 tricks
   - Fatty Bolger: Exactly 1 trick
   - Bill the Pony: Exactly 1 trick
   - Aragorn: Exactly N tricks (threat card value)
   - Goldberry: Exactly 3 consecutive tricks, no others

3. **Comparative objectives (isCompleted = finished && check)**:
   Depend on other players' final state.
   - Pippin: Win fewest tricks
   - Galadriel: Win neither fewest nor most tricks
   - Arwen: Win most forests cards
   - Gloin: Win most mountains cards

4. **End-game determined (isCompleted = finished && check)**:
   - Boromir: Win last trick + no 1-ring
   - Gildor Inglorian: Play forests in final trick
   - Tom Bombadil: Win 3+ cards matching suit in hand at end

5. **Special case (Bilbo Baggins)**:
   - isCompleted = check && (finished || 1-ring gone to someone else)
   - Can be completed early once 3+ tricks won AND 1-ring is won by another player

Type check passes with no errors.

## Completed: completedness-display

Add display for completed objectives:

Extended the UI to visually distinguish when a character's objective is definitively completed
(locked in, cannot be undone) vs merely "met" (currently passing but could still fail).

**Type changes (shared/types.ts)**:
- Added `completed: boolean` to CharacterStatus interface

**Game helper updates (shared/game.ts)**:
- Updated `displaySimple(met, completable, completed)` to accept and return completed field
- Updated `displayThreatCard(seat, met, completable, completed)` to pass through completed

**Character updates (all 25 character files)**:
Each character's `renderStatus` method now:
- Computes `completed = CharacterName.objective.isCompleted(game, seat)`
- Includes `completed` in the returned status object

**UI changes (client/PlayerSeat.tsx)**:
- Added new visual state for completed objectives: gold star (★)
- Rendering priority: completed (★) > met (✓) > not met (✗)

**CSS styling (client/game.css)**:
- Added `.objective-status .completed` with gold color (#ffd700)

Visual states now:
- ★ (gold) - Objective definitively completed, locked in
- ✓ (green) - Objective currently met but could still fail
- ✗ (red) - Objective not met
- ✗ (impossible) (red) - Objective can no longer be completed

Type check passes with no errors.

## Completed: early-victory-exit

End game early when all objectives are completed:

Previously, the game would continue until all tricks were played or until any player's objective
became impossible. Now the game also ends early when ALL players have definitively completed
their objectives, allowing players to celebrate victory without playing unnecessary tricks.

**Type fix (shared/types.ts)**:
- Added `isCompleted` method to the `objective` property of `CharacterDefinition` interface
- This aligns the type with the implementation in `shared/characters/types.ts`

**Game logic changes (shared/game.ts)**:
- Added `isObjectiveCompleted(gameState, seat)` helper function
- Added `allObjectivesCompleted(gameState)` function that returns true when all seats have
  completed objectives
- Updated `isGameOver()` to also return true when `allObjectivesCompleted()` is true
- Added log message "All objectives have been completed!" when early victory occurs

**How it works**:
After each trick, the game checks if all objectives are completed. If so, it logs a victory
message and the game loop exits, proceeding directly to the game over screen. This uses the
`isCompleted` method added in the completedness-checks feature, which returns true only when
an objective is definitively completed and cannot be undone.

Type check passes with no errors.
