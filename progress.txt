# PRD Progress Summary

## Completed: unused-client

Fixed unused imports and code in client files:

- client/App.tsx: Removed unused `useState` import
- client/GameLog.tsx: Wired up `CopyLogButton` (was defined but not rendered)
- client/LobbyMenu.tsx: Removed unused `handleGenerateCode` function
- client/usePlayerId.ts: Removed unused `useRef` import

All 4 issues from the prd.json "unused-client" item have been resolved.
Type check confirms the fixes are valid.

## Completed: unused-server

Fixed unused imports in server files:

- server/game-server.ts: Removed unused `runGame` import
- server/game-server.ts: Removed unused `characterRegistry` import
- server/smoke.ts: Removed unused `Game` import

All 2 files from the prd.json "unused-server" item have been cleaned up.
Type check confirms no new errors introduced.

## Completed: unused-shared

Fixed unused imports and parameters in shared files:

- shared/game.ts: Removed unused `PlayerHand`, `PyramidHand`, `SolitaireHand` imports
- shared/game.ts: Removed unused `AIController` import
- shared/game.ts: Removed unused `Controller` type import
- shared/game.ts: Removed unused `allCharacterNames` import and `allCharacters` constant
- shared/hands.ts: Prefixed unused `isOwnSeat` parameter with underscore in PyramidHand.serializeForViewer
- shared/hands.ts: Prefixed unused `isOwnSeat` parameter with underscore in SolitaireHand.serializeForViewer

All issues from the prd.json "unused-shared" item have been resolved.
Type check confirms no TS6xxx (unused) errors remain in these files.

## Completed: undefined-client

Fixed possibly undefined 'seat' access in client files:

- client/GameStatus.tsx: Added early return when seat is undefined
- client/TrickArea.tsx: Used optional chaining (seat?.character, seat?.playerName) for safe access

Both client type errors (TS18048) have been resolved.
Type check confirms no client errors remain.

## Completed: undefined-game-server

Fixed possibly undefined access in server/game-server.ts:

- Lines 21-24: Extracted `controllers[0]` into `singleController` const with non-null assertion before pushing
- Line 52: Added non-null assertion to `playerCards[p]!` since `p` is bounded by `numCharacters`
- Line 63: Added non-null assertion to `controllers[i]!` since `i` is bounded by `numCharacters`

All 3 type errors (TS2345, TS2532, TS2322) in game-server.ts have been resolved.
Type check confirms no game-server.ts errors remain.

## Completed: undefined-utilities

Fixed possibly undefined access in shared utility files:

- shared/hands.ts:299 - Added non-null assertions to array swap in `_ensureOneRingRevealed` (indices are guaranteed valid by preceding check)
- shared/utils.ts:31 - Added non-null assertions to array swap in `shuffleDeck` (Fisher-Yates shuffle indices are always valid)
- shared/controllers.ts:88 - Added non-null assertion in `randomChoice` return (function is called with non-empty arrays)

All 3 type errors (TS2322) in shared utilities have been resolved.
Type check confirms no errors remain in hands.ts, utils.ts, or controllers.ts.

## Completed: undefined-characters

Fixed possibly undefined access in shared/characters/registry.ts:

- Goldberry.objective.check (line 415): Added non-null assertions for `trickNumbers[0]!` and `trickNumbers[1]!` after length check
- Goldberry.objective.isCompletable (line 437): Added non-null assertions for `trickNumbers[i]!` and `trickNumbers[i-1]!` in loop
- Goldberry.objective.isCompletable (line 444): Added undefined check for `maxTrickWon` before using it
- GildorInglorian.objective.check (line 573): Fixed boolean | undefined return by adding explicit undefined check for `lastCardPlayed`
- Elrond.setup (lines 876-891): Changed indexed loop to for-of for first loop, added non-null assertions for array access in second and third loops

All 11 type errors (TS2532, TS18048, TS2322, TS2345) in registry.ts have been resolved.
Type check confirms no registry.ts errors remain.

## Completed: undefined-game

Fixed ~30 TypeScript errors in shared/game.ts related to possibly undefined array access:

**Design improvement**: Refactored `isLegalMove` and `getLegalMoves` to take `Seat` instead of `playerIndex`. This pushes undefined checking to call sites with proper context, rather than silently returning empty results which could mask bugs.

**Key fixes**:
- setupExchange: Added guards for validPlayers[0] and seats[targetIndex] lookups
- getGameOverMessage: Added safe seat lookup in winner name mapping
- determineTrickWinner: Added guard for currentTrick[0] with explicit error for empty tricks
- playSelectedCard/selectCardFromPlayer: Refactored to take Seat parameter directly
- runTrickTakingPhase: Get seat once at loop start with throw on invalid index; fixed oneRingPlay and winner seat access
- runSetupPhase: Added seat validation with throw on invalid index
- runCharacterAssignment: Added validation for frodoSeat, pyramid seat, and loop seats

All 33 TypeScript errors have been resolved.
Type check confirms no errors remain in shared/game.ts.

## Completed: sort-characters-alphabetically

Sorted available characters alphabetically for easier selection:

- server/game-server.ts: Added `.sort()` call after creating available characters list

Characters are now displayed in alphabetical order (e.g., Aragorn, Arwen, Boromir, Frodo...)
instead of random shuffle order. This makes it easier for players to find their preferred character.
Type check confirms no errors introduced.

## Completed: give-card-recipient

Show recipient name in Give Card dialog:

The `DecisionDialog` React component was not displaying the `message` field from choice options,
which meant the recipient's name wasn't shown in card-giving dialogs (e.g., Fatty Bolger's setup).

**Fix (client/DecisionDialog.tsx)**:
- Added `message` prop to the internal `Dialog` component
- Rendered message as `<p className="dialog-message">` between title and buttons
- Updated both `choose_button` and `choose_card` cases to pass `decision.options.message`

Now the dialog shows "Choose a card to give to [Character Name]" below the title.
The CSS class `.dialog-message` already existed with appropriate styling.

Type check passes with no errors.

## Completed: fatty-card-reveal

Publish gameState on card reveal for Fatty Bolger:

In 1-player mode, Fatty Bolger's setup reveals their hand before the card gift dialogs.
However, the `revealHand()` method wasn't calling `notifyStateChange()`, so the game
state wasn't published until the next operation (`giveCard()`). This caused the card
gift dialog to appear before the revealed cards were visible to the player.

**Fix (shared/game.ts)**:
- Added `this.notifyStateChange()` call at the end of `revealHand()` method

Now the revealed cards are visible before the gift dialog appears, as expected.
Type check passes with no errors.

## Completed: one-ring-skip-prompt

Skip one ring trump prompt when already winning:

When the 1 of Rings is played, the player is asked whether to use it as trump to win
the trick. However, if the 1 of Rings would already win without trump (i.e., rings is
the lead suit and no higher rings card was played), this prompt is unnecessary and
disrupts gameplay.

**Fix (shared/game.ts)**:
- Added `alreadyWinning` check before showing the trump prompt
- Condition: `leadSuit === "rings"` AND no rings card with `value > 1` was played
- When already winning, skip the prompt entirely (normal trick winner logic applies)

This improves UX by avoiding an obvious "Yes" choice when the player would win anyway.
Type check passes with no errors.

## Completed: log-player-names

Show player names instead of numbers in game log:

Before this change, log messages during character selection showed "Player 1 chose Gandalf"
instead of the actual player names. The `getDisplayName()` method fell back to "Player X"
when no character was assigned, ignoring `controller.playerName`.

**Fix (shared/seat.ts)**:
- Updated `getDisplayName()` to use `controller.playerName ?? 'Player ${seatIndex + 1}'`
  as fallback when no character is assigned yet
- Removed "(You)" annotations throughout since player names make them redundant
- Kept "(Pyramid)" annotation as it indicates a game mode, not a player identity

Now for networked games:
- Before character selection: Shows actual player names (e.g., "Alice chose Gandalf")
- After character selection: Shows character names (e.g., "Gandalf plays 3 of Hills")

For local/solitaire games, falls back to "Player X" when no name is set.
Type check passes with no errors.

## Completed: broken-rings-indicator

Add visual indication when rings are broken:

In this trick-taking game, players cannot lead with Rings suit cards until rings have
been "broken" (a Rings card has been played for any reason). The `ringsBroken` flag
was tracked in the game state and serialized to clients, but there was no visual
indicator showing this state to players.

**Changes**:
- `client/TrickArea.tsx`: Added a rings status indicator next to the trick area title
  - Wrapped h2 and indicator in a `.trick-header` div
  - Shows "Rings: Sealed" (blue styling) when rings haven't been broken yet
  - Shows "Rings: Broken" (orange styling) once any Rings card has been played
- `client/game.css`: Added styling for the rings status badge
  - Added `.trick-header` flex container for title and indicator
  - Added `.trick-header h2` to remove margin for proper alignment
  - Added `.rings-status` base styles with padding and border-radius
  - Added `.rings-status.sealed` with blue color scheme
  - Added `.rings-status.broken` with orange color scheme

This helps players understand when they can lead with Rings cards.
Type check passes with no errors.

## Completed: exchange-privacy

Respect privacy in exchange log messages:

When players exchange cards during setup (e.g., Frodo exchanging with Gandalf), the log
previously showed card details to ALL players. This leaked private information about
cards transferred between specific players.

**Changes**:
- `shared/game.ts`: Extended `log()` method signature to accept visibility options:
  - `visibleTo?: number[]` - seat indices that should see the detailed message
  - `hiddenMessage?: string` - alternative message shown to non-participants
- `shared/game.ts`: Updated `giveCard()` to use privacy-aware logging:
  - Participants see: "Gandalf gives 3 of Hills to Frodo"
  - Others see: "Gandalf gives a card to Frodo"
- `shared/game.ts`: Updated `completeExchange()` to use privacy-aware logging:
  - Both log lines (one per direction) now respect participant privacy
- `server/room-manager.ts`: Updated `onLog` callback to handle per-seat messaging:
  - Looks up each player's seat via their controller
  - Sends detailed message to participants, hidden message to others

Now only players involved in an exchange see the specific cards traded.
Type check passes with no errors.

## Completed: hills-color

Make hills suit color browner:

The Hills suit cards previously used a golden/yellow color gradient that was too similar
to the Rings suit and didn't evoke the earthy "hills" theme well.

**Fix (client/game.css)**:
- Changed `.card.hills` background gradient from `#ccb342 → #aea551` (golden yellow)
  to `#c4965c → #a8824a` (warm tan-brown)

The new colors are noticeably browner with more red and less green, creating an
earthier appearance that better represents rolling hills while maintaining good
contrast for readability.

## Completed: split-character-registry

Split characters/registry.ts into one file per character:

The original registry.ts contained all 25 character definitions in a single 1253-line file.
This made it difficult to find and modify individual character implementations. Splitting
into separate files is a precondition for implementing completedness checks.

**New file structure (shared/characters/)**:
- `types.ts` - Shared interfaces: CharacterDefinition, CharacterObjective, CharacterDisplay
- Individual character files (25 total):
  - `frodo.ts`, `gandalf.ts`, `merry.ts`, `celeborn.ts`, `pippin.ts`
  - `boromir.ts`, `sam.ts`, `gimli.ts`, `legolas.ts`, `aragorn.ts`
  - `goldberry.ts`, `glorfindel.ts`, `galadriel.ts`, `gildor-inglorian.ts`
  - `farmer-maggot.ts`, `fatty-bolger.ts`, `tom-bombadil.ts`
  - `barliman-butterbur.ts`, `bill-the-pony.ts`, `elrond.ts`
  - `arwen.ts`, `gloin.ts`, `bilbo-baggins.ts`, `gwaihir.ts`, `shadowfax.ts`
- `registry.ts` - Imports all characters and exports characterRegistry and allCharacterNames

**Unchanged external API**:
- `characterRegistry` - Map<string, CharacterDefinition> (same as before)
- `allCharacterNames` - string[] (same as before)
- Type exports via `export type { CharacterDefinition, ... }` from registry.ts

Each character file exports a single const with the character definition, containing
its name, setupText, setup function, objective, and display configuration.
Type check passes with no errors.

## Completed: completedness-checks

Implement isCompleted for each character:

Added `isCompleted` method to the `CharacterObjective` interface and implemented it for all
25 characters. This method returns true when a character's objective is definitively completed
and cannot be undone, enabling the early-victory-exit feature (future PRD item).

**Interface change (shared/characters/types.ts)**:
- Added `isCompleted: (game: Game, seat: Seat) => boolean` to CharacterObjective

**Implementation categories**:

1. **"At least X" objectives (isCompleted = check)**:
   Once met, these cannot be undone since won cards/tricks are permanent.
   - Gandalf: Win at least one trick
   - Frodo: Win at least 2/4 ring cards
   - Sam/Legolas/Gimli: Win specific threat card
   - Celeborn: Win 3+ cards of same rank
   - Glorfindel: Win all 8 shadows cards
   - Gwaihir: Win 2+ tricks with mountains
   - Shadowfax: Win 2+ tricks with hills
   - Farmer Maggot: Win 2+ cards matching threat rank
   - Barliman Butterbur: Win 1+ of last 3 tricks
   - Elrond: Every character has won a ring

2. **"Exact count" objectives (isCompleted = finished && check)**:
   Could be undone by winning too many; must wait for game end.
   - Merry: Exactly 1 or 2 tricks
   - Fatty Bolger: Exactly 1 trick
   - Bill the Pony: Exactly 1 trick
   - Aragorn: Exactly N tricks (threat card value)
   - Goldberry: Exactly 3 consecutive tricks, no others

3. **Comparative objectives (isCompleted = finished && check)**:
   Depend on other players' final state.
   - Pippin: Win fewest tricks
   - Galadriel: Win neither fewest nor most tricks
   - Arwen: Win most forests cards
   - Gloin: Win most mountains cards

4. **End-game determined (isCompleted = finished && check)**:
   - Boromir: Win last trick + no 1-ring
   - Gildor Inglorian: Play forests in final trick
   - Tom Bombadil: Win 3+ cards matching suit in hand at end

5. **Special case (Bilbo Baggins)**:
   - isCompleted = check && (finished || 1-ring gone to someone else)
   - Can be completed early once 3+ tricks won AND 1-ring is won by another player

Type check passes with no errors.

## Completed: completedness-display

Add display for completed objectives:

Extended the UI to visually distinguish when a character's objective is definitively completed
(locked in, cannot be undone) vs merely "met" (currently passing but could still fail).

**Type changes (shared/types.ts)**:
- Added `completed: boolean` to CharacterStatus interface

**Game helper updates (shared/game.ts)**:
- Updated `displaySimple(met, completable, completed)` to accept and return completed field
- Updated `displayThreatCard(seat, met, completable, completed)` to pass through completed

**Character updates (all 25 character files)**:
Each character's `renderStatus` method now:
- Computes `completed = CharacterName.objective.isCompleted(game, seat)`
- Includes `completed` in the returned status object

**UI changes (client/PlayerSeat.tsx)**:
- Added new visual state for completed objectives: gold star (★)
- Rendering priority: completed (★) > met (✓) > not met (✗)

**CSS styling (client/game.css)**:
- Added `.objective-status .completed` with gold color (#ffd700)

Visual states now:
- ★ (gold) - Objective definitively completed, locked in
- ✓ (green) - Objective currently met but could still fail
- ✗ (red) - Objective not met
- ✗ (impossible) (red) - Objective can no longer be completed

Type check passes with no errors.

## Completed: early-victory-exit

End game early when all objectives are completed:

Previously, the game would continue until all tricks were played or until any player's objective
became impossible. Now the game also ends early when ALL players have definitively completed
their objectives, allowing players to celebrate victory without playing unnecessary tricks.

**Type fix (shared/types.ts)**:
- Added `isCompleted` method to the `objective` property of `CharacterDefinition` interface
- This aligns the type with the implementation in `shared/characters/types.ts`

**Game logic changes (shared/game.ts)**:
- Added `isObjectiveCompleted(gameState, seat)` helper function
- Added `allObjectivesCompleted(gameState)` function that returns true when all seats have
  completed objectives
- Updated `isGameOver()` to also return true when `allObjectivesCompleted()` is true
- Added log message "All objectives have been completed!" when early victory occurs

**How it works**:
After each trick, the game checks if all objectives are completed. If so, it logs a victory
message and the game loop exits, proceeding directly to the game over screen. This uses the
`isCompleted` method added in the completedness-checks feature, which returns true only when
an objective is definitively completed and cannot be undone.

Type check passes with no errors.

## Completed: room-code-leave-existing

Leave existing room when setting a new room code:

When a player set a new room code (e.g., by manually editing the URL hash or using browser
back/forward), the client would attempt to join the new room without first leaving the
current room. This caused the server to reject the join with "Already in a room" error.

**Issue analysis (server/room-manager.ts:41-61)**:
- The `joinRoom` method checks if the socket is already in a room via `socketToPlayer` map
- If the socket is in a different room than requested, it throws "Already in a room"
- This is correct behavior - the client needs to leave first

**Fix (client/App.tsx)**:
- Added a check in the `useEffect` that handles room joining
- Before sending `join_room`, checks if `state.roomCode` (server-confirmed room) exists
  and differs from `roomCode` (target room from URL/local state)
- If so, sends `leave_room` message first to cleanly exit the current room
- Then proceeds with `join_room` for the new room

This ensures the client properly leaves its current room before joining a different one,
preventing the "Already in a room" error when changing room codes.

Type check passes with no errors.

## Completed: play-again

Add play again option after game over:

After a game ends (whether through completion, early victory, or impossible objectives), players
are now presented with a "Play Again?" dialog. All players see the dialog simultaneously, and
the first response from any player determines the outcome for everyone.

**Protocol changes (shared/protocol.ts)**:
- Added `game_reset` server message type with `players` field
- This message tells clients to return to the lobby state while keeping them in the room

**Client changes (client/reducer.ts)**:
- Added handler for `game_reset` message
- Clears `gameState`, `pendingDecision`, and `gameLog`
- Updates `players` list from the message (in case connections changed)

**Server changes (server/room-manager.ts)**:
- Refactored `startGame()` to await `runGame()` and implement a play-again loop
- Added `askPlayAgain()` method:
  - Sends decision request to all players with same `requestId`
  - First response resolves the promise (first-response-wins pattern)
  - Stores handler on room object for routing in `handleDecisionResponse()`
- Added `resetRoomToLobby()` method:
  - Clears game state, controllers, and started flag
  - Broadcasts `game_reset` to all players
- Updated `handleDecisionResponse()`:
  - Checks for play-again response before routing to controllers
  - Routes to stored handler if request ID matches

**Game flow**:
1. Game ends → `runGame()` returns
2. Server sends "Play Again?" dialog to all players
3. First player to respond determines outcome:
   - "Yes" → Reset room state, start new game (loop continues)
   - "No" → Reset room to lobby state (players return to room screen)
4. Players can then start another game from the lobby or leave the room

Type check passes with no errors.

---

## Unit Tests for Shared Code

**Task**: Create a unit test for something in @shared

**Changes made**:

**package.json**:
- Added `"test": "bun test"` script to run tests with Bun's built-in test runner

**shared/utils.test.ts** (new file):
- Created unit tests for `sortHand()` function:
  - Sorts cards by suit order (mountains < shadows < forests < hills < rings)
  - Sorts cards within same suit by value ascending
  - Handles mixed cards with suit-first, value-second ordering
  - Edge cases: empty array, single card

- Created unit tests for `shuffleDeck()` function:
  - Preserves all elements after shuffle
  - Does not modify original array (returns new array)
  - Works with Card objects
  - Edge cases: empty array, single element

**Test results**: 11 tests pass, 0 fail

This establishes the test infrastructure for the project. Future tests can follow this pattern using Bun's native `describe()`, `test()`, and `expect()` from "bun:test".

---

## WebSocket Reconnection Logic

**Task**: Implement websocket reconnection logic

**Changes made**:

**client/useGameWebSocket.ts**:
- Added `useCallback` import from React
- Added `reconnectTimeoutRef` to track pending reconnection timeout
- Added `reconnectAttemptRef` to track number of reconnection attempts
- Wrapped WebSocket connection logic in `connect` callback function
- On websocket close: automatically schedule reconnection with exponential backoff (1s, 2s, 4s, 8s, max 10s)
- On successful connect: reset reconnect attempt counter to 0
- On unmount: clear any pending reconnection timeout

**How it works**:
1. When the websocket closes, a reconnection is automatically scheduled
2. Exponential backoff prevents overwhelming the server: 1s → 2s → 4s → 8s → 10s (max)
3. When reconnected, App.tsx's existing useEffect auto-rejoins the room using playerId/roomCode/playerName from localStorage/URL hash
4. Server-side already handles reconnection: finds the player's seat, sends current game state and any pending decision requests

**Why no state reset**:
- Game state is preserved during reconnection so the user can still see the game
- External storage (localStorage, URL hash) preserves identity data needed to rejoin
- Server will send updated game state upon successful rejoin

Type check and tests pass.

## Current Trick Min Height Fix

Added min-height to .trick-cards in game.css to prevent layout shift when the current trick area is empty.

**Change**: Added `min-height: var(--card-height)` to `.trick-cards` class (client/game.css:222)

## Completed: clear-game-log

Clear game log when starting a new game via play-again.

When a player chose "Yes" to play again after a game ended, the game log from the previous
game was not being cleared. This caused logs to accumulate across multiple games, which
was confusing and cluttered the UI.

**Root cause**:
The `game_reset` message (which clears the log on clients) was only sent in `resetRoomToLobby()`,
which is called when a player chooses "No" to play again. When choosing "Yes", the server
cleared its internal state (`room.controllers.clear()`, `room.game = null`) but never notified
clients to clear their logs.

**Fix (server/room-manager.ts:316-329)**:
- Added `game_reset` message broadcast inside the `if (playAgain)` block
- Sends to all players before starting the new game
- Clears game log, game state, and pending decision on all clients
- New game state is sent immediately after as the new game initializes

Now when players choose to play again, the log is cleared before the new game begins.

## Completed: remove-trump-text

Remove redundant "(TRUMP)" text from trick display:

When a player used the 1 of Rings as trump to win a trick, the label showed "(TRUMP)"
next to their name. This text was redundant since ring cards already have a distinctive
gold/yellow background color that visually indicates they are the trump suit.

**Fix (client/TrickArea.tsx:43)**:
- Removed the `(play.isTrump ? " (TRUMP)" : "")` suffix from the label
- Simplified by removing the unnecessary `label` intermediate variable
- Now the player label just shows the player/character name

The visual distinction of the gold-colored rings card is sufficient to indicate trump plays.
Type check passes with no errors.

## Completed: farmer-maggot-setup-text

Fix Farmer Maggot's setup text to remove misleading "Hills" reference:

Farmer Maggot's setup text incorrectly read "Draw a Hills threat card, then exchange with
Merry or Pippin". The word "Hills" is misleading because:

1. The threat card is just a number (1-8), not tied to any suit
2. Farmer Maggot's objective is to win cards of ANY suit matching the threat card rank
3. Other characters (Sam, Gimli, Legolas) mention specific suits because their objectives
   require cards from that specific suit

Compare objectives:
- Sam: "Win the Hills card matching your threat card" → suit-specific
- Farmer Maggot: "Win at least two cards matching the threat card rank" → any suit

**Fix (shared/characters/farmer-maggot.ts:6)**:
- Changed setupText from "Draw a Hills threat card, then exchange with Merry or Pippin"
- To: "Draw a threat card, then exchange with Merry or Pippin"

Type check passes with no errors.

## Could Not Reproduce: pyramid-control

Investigated report that pyramid control log showed wrong player name.

**Reported Issue:**
- Adam at seat 0, L at seat 1, Pyramid at seat 2
- Log said "Adam controls Pyramid" but L was actually controlling it
- Rule: when pyramid is Frodo, the player BEFORE the pyramid in turn order controls it

**Investigation (shared/game.ts:806-828):**
- Formula `(startPlayer + 2) % 3` correctly calculates the seat BEFORE the pyramid
- For pyramid at seat 2: (2+2)%3 = 1, which is the correct "before" seat
- Both `setController()` and log message use the same `pyramidControllerSeat` variable
- Ran 2-player smoke tests with named controllers - all results showed correct controller

**Conclusion:**
Could not reproduce. The formula and logging appear correct. May have been a one-time
issue or misremembered scenario. Marking as could not reproduce.

## Completed: galadriel-setup-fix

Fix Galadriel's setup action to only show valid exchange options.

**Problem:**
Galadriel's setup was broken in multiple ways:
1. Always offered "Gandalf" as an option even when Gandalf wasn't in the game
2. Always offered "Lost Card" even if it had already been taken
3. No option to skip the exchange entirely

**Fix (shared/characters/galadriel.ts):**
- Dynamically build options array based on actual game state
- Check if Gandalf is in play: `game.seats.some(s => s.character === "Gandalf")`
- Check if lost card exists: `game.lostCard` is not null
- If no valid options exist, skip setup entirely (return early)
- If options exist, add "Skip" option and present single choice prompt
- Updated setupText to reflect optional nature: "Optionally exchange with Gandalf or the lost card"

**How it works now:**
- If both Gandalf in play AND lost card exists: Shows "Gandalf", "Lost Card", "Skip"
- If only Gandalf in play: Shows "Gandalf", "Skip"
- If only lost card exists: Shows "Lost Card", "Skip"
- If neither: No prompt shown, setup completes silently

Type check passes with no errors.

## Completed: shadowfax-mechanic

Implement Shadowfax 'set one card aside' mechanic:

Shadowfax's character ability allows them to set one card aside during setup. This card
doesn't count as part of their hand but can be returned at any point. If their hand
becomes empty, the aside card must be returned automatically.

**Changes made:**

**shared/seat.ts:**
- Added `asideCard: Card | null` field to Seat class to track the card set aside

**shared/characters/shadowfax.ts:**
- Implemented setup function that prompts player to choose a card to set aside
- Card is removed from hand and stored in `seat.asideCard`
- Log message shows "sets a card aside" (card details only visible to Shadowfax player)

**shared/game.ts:**
- Added `returnAsideCard(seat)` method to Game class for returning the aside card to hand
- Modified `runTrickTakingPhase()`:
  - Auto-returns aside card when hand is empty (before the "passes" check)
  - Before each card selection, if player has an aside card, prompts "Return to Hand" or "Keep Aside"

**shared/serialized.ts:**
- Added `asideCard: Card | "hidden" | null` to SerializedSeat interface
- Other players see "hidden" when Shadowfax has an aside card

**shared/serialize.ts:**
- Updated `serializeSeat()` to include aside card (visible only to owner)
- Added Card type import

**client/PlayerSeat.tsx:**
- Added aside card display with "Aside:" label
- Uses existing Card component which handles "hidden" value

**client/game.css:**
- Added `.aside-card` styling for flex layout
- Added `.aside-label` with blue color for visibility

Type check and tests pass.

## Completed: bilbo-mechanic

Implement Bilbo Baggins 'choose next leader' mechanic:

Bilbo Baggins has a special ability: "Whenever Bilbo wins a trick, he may choose who leads the next trick."
This was previously noted as a TODO in the character file but never implemented.

**Changes made:**

**shared/game.ts (runTrickTakingPhase):**
- Added logic after determining trick winner, before setting next leader
- When Bilbo wins a trick AND the game will continue:
  - Build list of players who still have cards (or an aside card)
  - If more than one eligible player, prompt Bilbo to choose
  - Show button choice with all eligible player names
  - Log message when Bilbo chooses someone other than himself

**shared/characters/bilbo-baggins.ts:**
- Removed TODO comment from setup function
- Added clarifying comment that the mechanic is in runTrickTakingPhase

**Behavior:**
- When Bilbo wins a trick, a dialog appears: "Choose who leads the next trick"
- Options show all players who have cards remaining (including those with aside cards)
- If only one player has cards, no prompt is shown (no choice to make)
- If game is ending (last trick), no prompt is shown
- AI Bilbo will make a random choice (existing AIController behavior)

Type check and tests pass.

## Completed: play-again-timeout and play-again-cleanup

Add timeout for play-again responses and clean up handler properly:

When a game ends, players are shown a "Play Again?" dialog. Previously, if all players disconnected
or failed to respond, the promise would never resolve, causing the game to hang indefinitely.
Additionally, the play-again state was stored using `as any` casts instead of proper typing.

**Changes (server/room-manager.ts):**

**Room interface extension:**
- Added `playAgainHandler?: (playerId: string, requestId: string, response: boolean) => void`
- Added `playAgainRequestId?: string`
- Added `playAgainTimeout?: ReturnType<typeof setTimeout>`
- Removed all `(room as any)` casts in favor of properly typed properties

**askPlayAgain() method:**
- Added 1-hour timeout (PLAY_AGAIN_TIMEOUT_MS = 60 * 60 * 1000)
- Added `cleanup()` helper function that:
  - Clears the timeout if pending
  - Deletes playAgainHandler, playAgainRequestId, and playAgainTimeout from room
- Timeout resolves to false (return to lobby) if no player responds
- cleanup() is called on both successful response and timeout

**resetRoomToLobby() method:**
- Updated to use properly typed room properties
- Clears timeout if still pending (defensive cleanup)

**handleDecisionResponse() method:**
- Updated to use `room.playAgainHandler` and `room.playAgainRequestId` directly

**Behavior:**
- If any player responds within 1 hour, their choice is used
- If no player responds within 1 hour, defaults to false (return to lobby)
- All play-again state is properly cleaned up in all code paths
- No more `as any` casts for play-again handling
- Return type changed from "yes"|"no" to boolean for cleaner code

Type check and tests pass.

## Completed: tom-bombadil-completable

Implement proper isCompletable logic for Tom Bombadil:

Tom Bombadil's objective is: "Win 3 or more cards matching the suit of a card left in hand at the end of round."
The previous `isCompletable` always returned `true` when the game wasn't finished, which was too optimistic.
The game should end early if Tom's objective becomes impossible.

**Fix (shared/characters/tom-bombadil.ts)**:
- Count how many cards of each suit Tom has already won
- Count total cards won by all players for each suit
- Calculate remaining cards in play per suit (using known totals: 8 for normal suits, 5 for rings)
- For each suit still in hand, check if `alreadyWon + remainingInPlay >= 3`
- Return false if no suit in hand can reach 3 won cards
- Also return false early if hand is empty (no card to match at end)

**How it works**:
1. If hand is empty, return false (can't have matching suit at game end)
2. For each unique suit in the current hand:
   - Calculate needed = 3 - wonBySuit
   - If needed <= 0, already have 3+ of this suit, return true
   - Otherwise check if remainingInPlay >= needed
3. If no suit in hand can reach 3, return false

Type check and tests pass.

## Completed: bilbo-completable

Fix Bilbo isCompletable to check trick achievability:

Bilbo Baggins' objective is: "Win 3 or more tricks; do NOT win the 1 of Rings."
The previous `isCompletable` only checked if Bilbo already had the 1 of Rings,
but did not verify whether 3 tricks were still achievable. This could cause the
game to continue when Bilbo's objective was already impossible.

**Fix (shared/characters/bilbo-baggins.ts)**:
- Added check for `tricksWon + game.tricksRemaining() >= 3`
- Combined with existing 1-Ring check using early return pattern
- If either condition fails, the objective is impossible

**How it works**:
1. If Bilbo has already won the 1 of Rings → return false (impossible)
2. If the remaining tricks plus already won tricks < 3 → return false (impossible)
3. Otherwise → return true (still possible)

This ensures the game ends early if Bilbo cannot possibly reach 3 tricks,
improving the early-game-over detection.

Type check and tests pass.
