# Riders Implementation Plan

## Overview

Add "riders" - additional objectives assigned to characters that must be completed alongside their normal character objective.

### Three Riders
1. **Morgul-Knife**: Do not lead with a ring card
2. **The Black Breath**: Win no rank 8 cards
3. **Terror**: Do not lead with a hills card

### Flow
1. At beginning of round, BEFORE character assignment, draw one rider randomly
2. The drawn rider is visible to all players during character selection
3. After character assignment, Frodo (player with 1 of Rings) assigns the rider to one character
4. The rider adds an extra objective - both character AND rider objectives must succeed

---

## Implementation Steps

### 1. Create Rider Types (`shared/riders/types.ts`)

Reuse `CharacterObjective` and `CharacterDisplay` from `shared/characters/types.ts` - riders and characters share the same interfaces.

```typescript
import type { CharacterObjective, CharacterDisplay } from "../characters/types";

export interface RiderDefinition {
  name: string;
  objective: CharacterObjective;  // Same interface as character objectives
  display: CharacterDisplay;      // Same interface - supports getObjectiveCards()
}
```

### 2. Create Rider Definitions

**`shared/riders/morgul-knife.ts`**
- Check all completed tricks + current trick for ring leads by this seat
- Final failure if any ring lead found
- Final success if game finished without violation
- Tentative success otherwise

**`shared/riders/black-breath.ts`**
- Check `seat.getAllWonCards()` for any value === 8
- Final failure if any rank 8 won
- Final success if game finished without 8s
- Tentative success otherwise
- `display.getObjectiveCards()` returns won rank 8 cards (to show failures)

**`shared/riders/terror.ts`**
- Same logic as Morgul-Knife but for hills suit

### 3. Create Rider Registry (`shared/riders/registry.ts`)

```typescript
export const riderRegistry = new Map<string, RiderDefinition>([...]);
export const allRiderNames = Array.from(riderRegistry.keys());
```

### 4. Update Seat Class (`shared/seat.ts`)

Add property:
```typescript
rider: RiderDefinition | null = null;
```

### 5. Update Game Class (`shared/game.ts`)

Add property:
```typescript
drawnRider: string | null = null;  // Rider name during assignment phase
```

### 6. Add Rider Drawing and Assignment (`shared/game.ts`)

**Draw rider** - add to start of `runCharacterAssignment()` (before any character picks):
1. Shuffle `allRiderNames` and draw first one
2. Set `game.drawnRider` to the drawn rider name
3. Log the drawn rider
4. `notifyStateChange()` so all players see the rider during character selection

**Assign rider** - create `runRiderAssignment()` function (called after character assignment):
1. Frodo's seat (`game.seats[game.leadPlayer]`) chooses which character receives it
2. Set `targetSeat.rider = riderRegistry.get(drawnRider)`
3. Clear `game.drawnRider`
4. Log the assignment

Call from `runGame()`: draw rider at start of character assignment, then call `runRiderAssignment()` after character assignment and before `runSetupPhase()`.

### 7. Update Objective Checking (`shared/game.ts`)

Modify these functions to check both character AND rider:

**`isObjectiveCompletable()`**:
```typescript
function isObjectiveCompletable(gameState: Game, seat: Seat): boolean {
  // Character check (existing)
  const charStatus = getObjectiveStatus(seat.character!.objective, gameState, seat);
  if (charStatus.finality === "final" && charStatus.outcome === "failure") {
    return false;
  }
  // Rider check (new)
  if (seat.rider) {
    const riderStatus = seat.rider.objective.getStatus(gameState, seat);
    if (riderStatus.finality === "final" && riderStatus.outcome === "failure") {
      return false;
    }
  }
  return true;
}
```

**`checkObjective()`**:
```typescript
function checkObjective(gameState: Game, seat: Seat): boolean {
  const charMet = getObjectiveStatus(seat.character!.objective, gameState, seat).outcome === "success";
  const riderMet = !seat.rider || seat.rider.objective.getStatus(gameState, seat).outcome === "success";
  return charMet && riderMet;
}
```

### 8. Update Serialization

**`shared/serialized.ts`** - Add to `SerializedSeat`:
```typescript
rider: string | null;
riderObjective: string | null;
riderStatus?: ObjectiveStatus;
riderObjectiveCards?: ObjectiveCards;  // For displaying rider-related cards (e.g., won 8s)
```

**`shared/serialized.ts`** - Add to `SerializedGame`:
```typescript
drawnRider: { name: string; objective: string } | null;  // Visible during character assignment
```

**`shared/serialize.ts`** - Update `serializeSeat()` to include rider fields.

### 9. Update UI

**`client/GameScreen.tsx`** - Show drawn rider during character assignment:
```tsx
{game.drawnRider && (
  <div className="drawn-rider">
    <h3>Rider: {game.drawnRider.name}</h3>
    <p>{game.drawnRider.objective}</p>
  </div>
)}
```

**`client/PlayerSeat.tsx`** - Add rider objective display below character objective:
```tsx
{rider && riderStatus && (
  <div className="rider-objective">
    <StatusIcon objectiveStatus={riderStatus} />
    <span className="font-xs italic">{riderObjective}</span>
  </div>
)}
```
Also display `riderObjectiveCards` if present (e.g., Black Breath showing won 8s).

### 10. Update CSS (`client/game.css`)

Add styles for `.rider-objective` display.

---

## Files to Modify

| File | Changes |
|------|---------|
| `shared/riders/types.ts` | NEW - RiderDefinition interface |
| `shared/riders/morgul-knife.ts` | NEW - Rider definition |
| `shared/riders/black-breath.ts` | NEW - Rider definition |
| `shared/riders/terror.ts` | NEW - Rider definition |
| `shared/riders/registry.ts` | NEW - Rider registry |
| `shared/seat.ts` | Add `rider` property |
| `shared/game.ts` | Add `drawnRider`, `runRiderAssignment()`, update objective checks |
| `shared/serialized.ts` | Add rider fields to SerializedSeat/SerializedGame |
| `shared/serialize.ts` | Serialize rider data |
| `client/PlayerSeat.tsx` | Display rider objective and objective cards |
| `client/GameScreen.tsx` | Display drawn rider during character assignment |
| `client/game.css` | Rider styling |

---

## Verification

1. **Start a game** - After character assignment, a rider should be drawn and assigned
2. **Check UI** - The assigned character should show both objectives
3. **Test Morgul-Knife** - Lead with a ring card, verify failure
4. **Test Black Breath** - Win a rank 8 card, verify failure
5. **Test Terror** - Lead with a hills card, verify failure
6. **Test success** - Complete a game avoiding the rider restriction, verify success
7. **Test combined** - Verify both character AND rider must succeed for overall success
