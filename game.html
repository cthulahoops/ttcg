<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trick Taking Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #2d5016;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #ffd700;
        }

        .lost-card-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: #1a3009;
            border-radius: 10px;
        }

        .lost-card-section h2 {
            margin-top: 0;
            color: #ffd700;
        }

        .players {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .player {
            background-color: #1a3009;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4a7023;
        }

        .player h3 {
            margin-top: 0;
            color: #ffd700;
        }

        .hand {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .card {
            width: 60px;
            height: 85px;
            border: 2px solid #333;
            border-radius: 5px;
            background-color: #fff;
            color: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        .card.mountains {
            background: linear-gradient(135deg, #8b7355 0%, #d4a574 100%);
        }

        .card.shadows {
            background: linear-gradient(135deg, #2c2c2c 0%, #5a5a5a 100%);
            color: #fff;
        }

        .card.forests {
            background: linear-gradient(135deg, #2d5016 0%, #4a7023 100%);
            color: #fff;
        }

        .card.hills {
            background: linear-gradient(135deg, #7cb342 0%, #aed581 100%);
        }

        .card.rings {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-color: #ff6f00;
            border-width: 3px;
        }

        .suit {
            font-size: 10px;
            text-transform: uppercase;
            margin-top: 3px;
        }

        .value {
            font-size: 24px;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        button {
            background-color: #ffd700;
            color: #1a3009;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #ffed4e;
        }

        .trick-area {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: #1a3009;
            border-radius: 10px;
            min-height: 150px;
        }

        .trick-area h2 {
            margin-top: 0;
            color: #ffd700;
        }

        .trick-cards {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .trick-card {
            text-align: center;
        }

        .trick-card .player-label {
            font-size: 12px;
            margin-bottom: 5px;
            color: #aed581;
        }

        .card.clickable {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .card.clickable:hover {
            transform: translateY(-5px);
        }

        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .card.hidden {
            background: linear-gradient(135deg, #4a4a4a 0%, #2c2c2c 100%);
            color: #888;
        }

        .card.hidden .value {
            font-size: 16px;
        }

        .card.hidden .suit {
            display: none;
        }

        .hand-count {
            color: #aed581;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .game-status {
            text-align: center;
            font-size: 18px;
            color: #ffd700;
            margin: 20px 0;
            font-weight: bold;
        }

        .player.active {
            border-color: #ffd700;
            border-width: 3px;
        }

        .tricks-won {
            font-size: 14px;
            color: #aed581;
            margin-top: 5px;
        }

        .trump-choice {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1a3009;
            border: 3px solid #ffd700;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .trump-choice h3 {
            color: #ffd700;
            margin-top: 0;
        }

        .trump-choice-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .trump-choice button {
            min-width: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trick Taking Game</h1>

        <div class="controls">
            <button onclick="newGame()">New Game</button>
        </div>

        <div class="game-status" id="gameStatus">Click "New Game" to start</div>

        <div id="trumpChoice" class="trump-choice" style="display: none;">
            <h3>You played the 1 of Rings!</h3>
            <p>Do you want to use it as trump to win this trick?</p>
            <div class="trump-choice-buttons">
                <button onclick="chooseTrump(true)">Yes, Win Trick</button>
                <button onclick="chooseTrump(false)">No, Play Normal</button>
            </div>
        </div>

        <div class="lost-card-section">
            <h2>Lost Card</h2>
            <div id="lostCard"></div>
        </div>

        <div class="trick-area">
            <h2>Current Trick</h2>
            <div class="trick-cards" id="trickCards"></div>
        </div>

        <div class="players">
            <div class="player">
                <h3>Player 1 (North)</h3>
                <div class="tricks-won" id="tricks1">Tricks: 0</div>
                <div class="hand" id="player1"></div>
            </div>
            <div class="player">
                <h3>Player 2 (East)</h3>
                <div class="tricks-won" id="tricks2">Tricks: 0</div>
                <div class="hand-count" id="count2">Cards: 9</div>
                <div class="hand" id="player2"></div>
            </div>
            <div class="player">
                <h3>Player 3 (South)</h3>
                <div class="tricks-won" id="tricks3">Tricks: 0</div>
                <div class="hand-count" id="count3">Cards: 9</div>
                <div class="hand" id="player3"></div>
            </div>
            <div class="player">
                <h3>Player 4 (West)</h3>
                <div class="tricks-won" id="tricks4">Tricks: 0</div>
                <div class="hand-count" id="count4">Cards: 9</div>
                <div class="hand" id="player4"></div>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            playerHands: [[], [], [], []],
            tricksWon: [[], [], [], []],  // Store cards from won tricks
            currentTrick: [],
            currentPlayer: 0,
            leadSuit: null,
            trickComplete: false,
            ringsBroken: false,
            waitingForTrumpChoice: false
        };

        const playerNames = ['North (You)', 'East', 'South', 'West'];

        function createDeck() {
            const deck = [];
            const normalSuits = ['mountains', 'shadows', 'forests', 'hills'];

            // Add normal suits (1-8)
            for (const suit of normalSuits) {
                for (let value = 1; value <= 8; value++) {
                    deck.push({ suit, value });
                }
            }

            // Add rings suit (1-5)
            for (let value = 1; value <= 5; value++) {
                deck.push({ suit: 'rings', value });
            }

            return deck;
        }

        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function sortHand(cards) {
            const suitOrder = { 'mountains': 0, 'shadows': 1, 'forests': 2, 'hills': 3, 'rings': 4 };

            return cards.sort((a, b) => {
                // First sort by suit
                if (suitOrder[a.suit] !== suitOrder[b.suit]) {
                    return suitOrder[a.suit] - suitOrder[b.suit];
                }
                // Then sort by value within the same suit
                return a.value - b.value;
            });
        }

        function createCardElement(card, clickable = false, clickHandler = null) {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card ${card.suit}`;
            if (clickable) {
                cardDiv.classList.add('clickable');
                if (clickHandler) {
                    cardDiv.onclick = clickHandler;
                }
            }

            const valueDiv = document.createElement('div');
            valueDiv.className = 'value';
            valueDiv.textContent = card.value;

            const suitDiv = document.createElement('div');
            suitDiv.className = 'suit';
            suitDiv.textContent = card.suit;

            cardDiv.appendChild(valueDiv);
            cardDiv.appendChild(suitDiv);

            return cardDiv;
        }

        function findPlayerWithCard(suit, value) {
            for (let p = 0; p < 4; p++) {
                if (gameState.playerHands[p].some(card => card.suit === suit && card.value === value)) {
                    return p;
                }
            }
            return -1;
        }

        function isLegalMove(playerIndex, card) {
            const playerHand = gameState.playerHands[playerIndex];

            // If leading the trick
            if (gameState.currentTrick.length === 0) {
                // Can't lead rings unless:
                // 1. Rings have been broken, OR
                // 2. Player only has rings
                if (card.suit === 'rings') {
                    const onlyHasRings = playerHand.every(c => c.suit === 'rings');
                    if (!gameState.ringsBroken && !onlyHasRings) {
                        return false;
                    }
                }
                return true;
            }

            // Must follow suit if possible
            const hasLeadSuit = playerHand.some(c => c.suit === gameState.leadSuit);

            if (hasLeadSuit) {
                return card.suit === gameState.leadSuit;
            }

            // If can't follow suit, can play anything
            return true;
        }

        function getLegalMoves(playerIndex) {
            return gameState.playerHands[playerIndex].filter(card => isLegalMove(playerIndex, card));
        }

        function playCard(playerIndex, card) {
            // Remove card from player's hand
            const handIndex = gameState.playerHands[playerIndex].findIndex(
                c => c.suit === card.suit && c.value === card.value
            );
            gameState.playerHands[playerIndex].splice(handIndex, 1);

            // Add to current trick
            gameState.currentTrick.push({ playerIndex, card, isTrump: false });

            // Set lead suit if this is the first card
            if (gameState.currentTrick.length === 1) {
                gameState.leadSuit = card.suit;
            }

            // Check if rings have been broken
            if (card.suit === 'rings') {
                gameState.ringsBroken = true;
            }

            // Check if trick is complete
            if (gameState.currentTrick.length === 4) {
                gameState.trickComplete = true;

                // Update display
                displayTrick();
                displayHands();

                // Check if 1 of rings was played
                const oneRingPlay = gameState.currentTrick.find(
                    play => play.card.suit === 'rings' && play.card.value === 1
                );

                if (oneRingPlay) {
                    // Ask the player who played it if they want to use it as trump
                    if (oneRingPlay.playerIndex === 0) {
                        // Human player - show dialog
                        gameState.waitingForTrumpChoice = true;
                        document.getElementById('trumpChoice').style.display = 'block';
                        return; // Wait for user choice
                    } else {
                        // AI player - decide automatically (always choose yes)
                        oneRingPlay.isTrump = true;
                    }
                }

                // Determine winner after a delay
                setTimeout(() => {
                    determineTrickWinner();
                }, 1500);
            } else {
                // Move to next player
                gameState.currentPlayer = (gameState.currentPlayer + 1) % 4;

                // Update display AFTER changing current player
                displayTrick();
                displayHands();
                updateGameStatus();

                // If it's an AI player's turn, play automatically
                if (gameState.currentPlayer !== 0) {
                    setTimeout(() => playAIMove(), 1000);
                }
            }
        }

        function chooseTrump(useTrump) {
            // Hide the dialog
            document.getElementById('trumpChoice').style.display = 'none';
            gameState.waitingForTrumpChoice = false;

            // Find the 1 of rings in the current trick and update its trump status
            const oneRingPlay = gameState.currentTrick.find(
                play => play.card.suit === 'rings' && play.card.value === 1
            );
            if (oneRingPlay) {
                oneRingPlay.isTrump = useTrump;
            }

            // Update display to show trump status
            displayTrick();

            // Determine winner after a short delay
            setTimeout(() => {
                determineTrickWinner();
            }, 1500);
        }

        function playAIMove() {
            const legalMoves = getLegalMoves(gameState.currentPlayer);
            const randomMove = legalMoves[Math.floor(Math.random() * legalMoves.length)];
            playCard(gameState.currentPlayer, randomMove);
        }

        function determineTrickWinner() {
            // Check if 1 of rings was played as trump
            const trumpPlay = gameState.currentTrick.find(play => play.isTrump);

            let winningPlay;
            let winMessage;

            if (trumpPlay) {
                // Trump wins
                winningPlay = trumpPlay;
                winMessage = `${playerNames[trumpPlay.playerIndex]} wins with the 1 of Rings (trump)!`;
            } else {
                // Find highest card of lead suit
                winningPlay = gameState.currentTrick[0];

                for (let i = 1; i < gameState.currentTrick.length; i++) {
                    const play = gameState.currentTrick[i];
                    if (play.card.suit === gameState.leadSuit && play.card.value > winningPlay.card.value) {
                        winningPlay = play;
                    }
                }

                winMessage = `${playerNames[winningPlay.playerIndex]} wins with ${winningPlay.card.value} of ${winningPlay.card.suit}`;
            }

            const winnerIndex = winningPlay.playerIndex;

            // Assign all cards from the trick to the winner
            gameState.currentTrick.forEach(play => {
                gameState.tricksWon[winnerIndex].push(play.card);
            });

            // Update tricks won display
            updateTricksDisplay();

            updateGameStatus(`Trick complete! ${winMessage}`);

            // Check if game is over
            if (gameState.playerHands[0].length === 0) {
                setTimeout(() => {
                    updateGameStatus('Game Over! ' + getGameOverMessage());
                }, 2000);
            } else {
                // Start next trick after a delay
                setTimeout(() => {
                    startNextTrick(winnerIndex);
                }, 2000);
            }
        }

        function getGameOverMessage() {
            const counts = gameState.tricksWon.map(tricks => tricks.length / 4);
            const maxTricks = Math.max(...counts);
            const winners = counts.map((count, idx) => count === maxTricks ? idx : -1).filter(idx => idx !== -1);

            if (winners.length === 1) {
                return `${playerNames[winners[0]]} wins with ${maxTricks} tricks!`;
            } else {
                return `Tie between ${winners.map(idx => playerNames[idx]).join(' and ')} with ${maxTricks} tricks each!`;
            }
        }

        function startNextTrick(leadPlayer) {
            // Clear the current trick
            gameState.currentTrick = [];
            gameState.leadSuit = null;
            gameState.trickComplete = false;
            gameState.currentPlayer = leadPlayer;

            // Clear trick display
            document.getElementById('trickCards').innerHTML = '';

            // Update display
            displayHands();
            updateGameStatus();

            // If AI player leads, play their move
            if (leadPlayer !== 0) {
                setTimeout(() => playAIMove(), 1000);
            }
        }

        function updateTricksDisplay() {
            for (let p = 0; p < 4; p++) {
                const trickCount = gameState.tricksWon[p].length / 4;
                document.getElementById(`tricks${p + 1}`).textContent = `Tricks: ${trickCount}`;
            }
        }

        function displayTrick() {
            const trickDiv = document.getElementById('trickCards');
            trickDiv.innerHTML = '';

            gameState.currentTrick.forEach(play => {
                const trickCardDiv = document.createElement('div');
                trickCardDiv.className = 'trick-card';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'player-label';
                labelDiv.textContent = playerNames[play.playerIndex] + (play.isTrump ? ' (TRUMP)' : '');

                trickCardDiv.appendChild(labelDiv);
                trickCardDiv.appendChild(createCardElement(play.card));
                trickDiv.appendChild(trickCardDiv);
            });
        }

        function displayHands() {
            const playerDivs = [
                document.getElementById('player1'),
                document.getElementById('player2'),
                document.getElementById('player3'),
                document.getElementById('player4')
            ];

            // Update active player indicator
            document.querySelectorAll('.player').forEach((div, idx) => {
                if (idx === gameState.currentPlayer && !gameState.trickComplete && !gameState.waitingForTrumpChoice) {
                    div.classList.add('active');
                } else {
                    div.classList.remove('active');
                }
            });

            // Display each player's hand
            for (let p = 0; p < 4; p++) {
                playerDivs[p].innerHTML = '';

                if (p === 0) {
                    // Human player - show actual cards
                    const sortedHand = sortHand([...gameState.playerHands[p]]);

                    sortedHand.forEach(card => {
                        const isPlayerTurn = gameState.currentPlayer === 0 && !gameState.trickComplete && !gameState.waitingForTrumpChoice;
                        const isLegal = isPlayerTurn && isLegalMove(p, card);

                        const cardElement = createCardElement(
                            card,
                            isPlayerTurn,
                            isLegal ? () => playCard(0, card) : null
                        );

                        if (isPlayerTurn && !isLegal) {
                            cardElement.classList.add('disabled');
                        }

                        playerDivs[p].appendChild(cardElement);
                    });
                } else {
                    // AI players - show card backs
                    const handSize = gameState.playerHands[p].length;

                    // Update card count
                    const countDiv = document.getElementById(`count${p + 1}`);
                    if (countDiv) {
                        countDiv.textContent = `Cards: ${handSize}`;
                    }

                    // Show card backs
                    for (let i = 0; i < handSize; i++) {
                        const cardBack = document.createElement('div');
                        cardBack.className = 'card hidden';

                        const valueDiv = document.createElement('div');
                        valueDiv.className = 'value';
                        valueDiv.textContent = '?';

                        cardBack.appendChild(valueDiv);
                        playerDivs[p].appendChild(cardBack);
                    }
                }
            }
        }

        function updateGameStatus(message = null) {
            const statusDiv = document.getElementById('gameStatus');

            if (message) {
                statusDiv.textContent = message;
            } else if (gameState.trickComplete) {
                statusDiv.textContent = 'Trick complete!';
            } else if (gameState.currentPlayer === 0) {
                statusDiv.textContent = 'Your turn! Click a card to play.';
            } else {
                statusDiv.textContent = `${playerNames[gameState.currentPlayer]}'s turn...`;
            }
        }

        function newGame() {
            let deck, lostCard;

            // Keep shuffling until the lost card is not the 1 of rings
            do {
                // Create and shuffle deck
                deck = shuffleDeck(createDeck());

                // Deal lost card
                lostCard = deck.shift();
            } while (lostCard.suit === 'rings' && lostCard.value === 1);

            // Display the lost card
            const lostCardDiv = document.getElementById('lostCard');
            lostCardDiv.innerHTML = '';
            lostCardDiv.appendChild(createCardElement(lostCard));

            // Reset game state
            gameState = {
                playerHands: [[], [], [], []],
                tricksWon: [[], [], [], []],
                currentTrick: [],
                currentPlayer: 0,
                leadSuit: null,
                trickComplete: false,
                ringsBroken: false,
                waitingForTrumpChoice: false
            };

            // Deal 9 cards to each player
            for (let i = 0; i < 9; i++) {
                for (let p = 0; p < 4; p++) {
                    const card = deck.shift();
                    gameState.playerHands[p].push(card);
                }
            }

            // Find who has the 1 of rings
            const startPlayer = findPlayerWithCard('rings', 1);
            gameState.currentPlayer = startPlayer;

            // Clear trick display
            document.getElementById('trickCards').innerHTML = '';

            // Hide trump choice dialog
            document.getElementById('trumpChoice').style.display = 'none';

            // Reset tricks won display
            updateTricksDisplay();

            // Display initial state
            displayHands();
            updateGameStatus();

            // If AI player starts, play their move
            if (startPlayer !== 0) {
                setTimeout(() => playAIMove(), 1000);
            }
        }

        // Start a game on page load
        newGame();
    </script>
</body>
</html>
